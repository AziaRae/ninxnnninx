server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        http3 on;
        quic_retry on;
        ssl_early_data on;
        quic_gso on;
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_dhparam /etc/nginx/dhparam.pem; 
        ssl_verify_client on;
        ssl_client_certificate /etc/nginx/ssl/cloudflare.crt;
        server_name imnot.uk;

        gzip on;
        gunzip on;
        gzip_static on;

        root /var/www/html/mee;
        index simula.html;

        # Images and media - reusable content
        location ~* \.(jpg|jpeg|png|gif|ico|webp|svg)$ {
            expires 7d;
            add_header Cache-Control "public, max-age=604800, must-revalidate, proxy-revalidate";
            add_header Vary Accept-Encoding;
            etag on;
            if_modified_since exact;
            try_files $uri =404;
        }

        # Video content
        location ~* \.(mp4|webm|mov|avi)$ {
            expires 30d;
            add_header Cache-Control "public, max-age=2592000, must-revalidate, proxy-revalidate";
            add_header Vary Accept-Encoding;
            etag on;
            if_modified_since exact;
            try_files $uri =404;
        }

        # Static files (CSS, JS, etc)
        location ~* \.(css|js|json|xml)$ {
            expires 7d;
            add_header Cache-Control "public, max-age=604800, must-revalidate";
            add_header Vary Accept-Encoding;
            etag on;
            if_modified_since exact;
            try_files $uri =404;
        }

        # HTML and dynamic content - with conditional cache
        # location ~* \.(html|htm|css|js)$ {
        #     expires 1h;
        #     add_header Cache-Control "public, no-cache, must-revalidate, proxy-revalidate";
        #     add_header Vary Accept-Encoding;
        #     etag on;
        #     if_modified_since exact;
        #     try_files $uri =404;
        # }

        location / {
            try_files $uri $uri.html $uri/ /simula.html =404;
            add_header Cache-Control "public, max-age=3600, must-revalidate, proxy-revalidate";
            expires 1h;
            add_header Vary Accept-Encoding;
            
            # Add error handling
            error_page 404 /404.html;
            error_page 500 502 503 504 /50x.html;
            
            # Add Cloudflare headers
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;
        }
}