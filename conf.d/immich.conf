# Immich HTTPS configuration
server {
    # HTTP/3 QUIC listeners (UDP) - Must come first
    listen 443 quic reuseport;
    listen [::]:443 quic reuseport;

    # HTTP/2 fallback listeners (TCP)
    listen 443 ssl;
    listen [::]:443 ssl;

    # Protocol enablement
    http2 on;
    http3 on;

    # QUIC optimizations
    quic_retry on;
    quic_gso on;
    ssl_early_data on;

    # TLS configuration (HTTP/3 requires TLS 1.3)
    ssl_protocols TLSv1.3;
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_dhparam /etc/nginx/dhparam.pem;
    ssl_verify_client on;
    ssl_client_certificate /etc/nginx/ssl/cloudflare.crt;

    server_name photos.imnot.uk immich.imnot.uk;

    # HTTP/3 advertisement header
    add_header Alt-Svc 'h3=":443"; ma=86400';

    # Security headers
    add_header Permissions-Policy "camera=self, microphone=self, geolocation=self, interest-cohort=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; worker-src 'self' blob:; frame-src 'self'; media-src 'self' blob:; connect-src 'self' wss: blob: *; object-src 'none'; form-action 'self'" always;

    client_body_buffer_size 4m;
    proxy_read_timeout 600;
    proxy_send_timeout 600;
    client_max_body_size 100M;

    # Logging configuration
    access_log /var/log/nginx/immich_access.log main;
    error_log /var/log/nginx/immich_error.log;

    # Global Proxy Headers
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket Support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_redirect off;

    # Caching configuration
    proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    proxy_cache_lock on;
    proxy_cache_lock_age 60s;
    proxy_cache_lock_timeout 60s;
    proxy_cache_min_uses 1;
    add_header X-Cache-Status $upstream_cache_status;
    aio threads;

    # Temporary debug header
    add_header X-Debug-Cache-Key $request_uri always;

    # Location blocks (保持原有缓存配置不变)
    # 1. Specific thumbnail regex match
    location ~ "^/api/assets/[a-f0-9-]+/thumbnail" {
        proxy_pass http://127.0.0.1:2283;
        proxy_cache thumbnails;
        proxy_cache_valid 200 30d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_key "$request_uri";
        proxy_cache_min_uses 1;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        proxy_ignore_headers Cache-Control Set-Cookie;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Pragma;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        add_header X-Cache-Status $upstream_cache_status always;
        proxy_buffering on;
        etag on;
        if_modified_since exact;
    }

    # 2. General assets prefix match
    location ^~ /api/assets {
        proxy_pass http://127.0.0.1:2283;
        proxy_cache assets_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_key "$request_uri$is_args$args";
        proxy_cache_min_uses 1;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        proxy_ignore_headers Cache-Control Set-Cookie;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Pragma;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        add_header Vary "Accept-Encoding" always;
        add_header X-Cache-Status $upstream_cache_status always;
        etag on;
        if_modified_since exact;
        expires 30d;
        client_max_body_size 0;
        client_body_buffer_size 128k;
        proxy_request_buffering off;
        proxy_buffering on;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 3600s;
    }

    # 3. API prefix match
    location ^~ /api {
        proxy_pass http://127.0.0.1:2283;
        proxy_buffering off;
        proxy_request_buffering off;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
    }

    # 4. Photos prefix match
    location ^~ /photos {
        proxy_pass http://127.0.0.1:2283;
        proxy_cache assets_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_key "$request_uri$is_args$args";
        proxy_cache_min_uses 1;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        proxy_ignore_headers Cache-Control Set-Cookie;
        proxy_hide_header Set-Cookie;
        proxy_hide_header Pragma;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        add_header Vary "Accept-Encoding" always;
        add_header X-Cache-Status $upstream_cache_status always;
        proxy_buffering on;
        etag on;
        if_modified_since exact;
        expires 30d;
    }

    # 5. People path - no caching
    location ^~ /people {
        proxy_pass http://127.0.0.1:2283;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_cache off;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
        add_header Pragma "no-cache" always;
        expires -1;
    }

    # 6. Default location
    location / {
        proxy_pass http://127.0.0.1:2283;
        proxy_cache my_cache;
        proxy_cache_valid 200 1h;
        proxy_cache_methods GET HEAD POST;
        proxy_cache_key "$scheme$request_method$host$request_uri$request_body";
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        proxy_cache_revalidate on;
        proxy_cache_min_uses 1;
        proxy_request_buffering on;
        proxy_buffering on;
        client_body_buffer_size 16k;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate, max-age=3600";
        add_header X-Cache-Status $upstream_cache_status always;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 300;
        add_header Pragma "no-cache" always;
        add_header CF-Cache-Status $upstream_cache_status always;
    }
}