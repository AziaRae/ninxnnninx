# Immich HTTPS configuration
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    http3 on;
    quic_retry on;
    ssl_early_data on;
    quic_gso on;
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_dhparam /etc/nginx/dhparam.pem; 
    ssl_verify_client on;
    ssl_client_certificate /etc/nginx/ssl/cloudflare.crt;
    server_name photos.imnot.uk immich.imnot.uk;
    client_body_buffer_size 4m;                 # Larger body buffer
    proxy_read_timeout 600;                     # Longer timeout for large transfers
    proxy_send_timeout 600;
    client_max_body_size 100M;

    # Enable logging for Immich
    access_log /var/log/nginx/immich_access.log;
    error_log /var/log/nginx/immich_error.log;

    # Global Proxy Headers
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Global WebSocket Support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_redirect off;

    # Common Caching Settings
    proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
    proxy_cache_lock on;  
    proxy_cache_lock_age 60s;                   # Longer lock age
    proxy_cache_lock_timeout 60s;               # Longer lock timeout
    proxy_cache_min_uses 1;                     # Cache after 2 requests
    add_header X-Cache-Status $upstream_cache_status;
    aio threads;

    # Add these headers to the server block for photos-specific security
    add_header Permissions-Policy "camera=self, microphone=self, geolocation=self, interest-cohort=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; worker-src 'self' blob:; frame-src 'self'; media-src 'self' blob:; connect-src 'self' wss: blob:; object-src 'none'" always;

    # Modified Content-Security-Policy for photos
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; worker-src 'self' blob:; frame-src 'self'; media-src 'self' blob:; connect-src 'self' wss: blob: *; object-src 'none'; form-action 'self'" always;

    # Thumbnails Caching
    location ~ ^/api/assets/[a-f0-9-]+/thumbnail {
        proxy_pass http://127.0.0.1:2283;

        # Enable caching
        proxy_cache thumbnails;
        proxy_cache_valid 200 30d;
        proxy_cache_valid any 5m;
        proxy_cache_revalidate on;
        proxy_cache_key "$request_uri";
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        proxy_cache_lock_timeout 5s;
        proxy_buffering on;

        # Cache control headers
        add_header Cache-Control "public, max-age=2592000, s-maxage=2592000, immutable" always;
        add_header X-Cache-Status $upstream_cache_status always;
        add_header X-Cache-Key $request_uri always;

        # Other headers
        add_header Vary "Accept-Encoding" always;
        etag on;
        if_modified_since exact;
        gzip_static on;
        proxy_hide_header Set-Cookie;
        proxy_ignore_headers Set-Cookie;

        # Security headers
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob:" always;

        # Remove directives that disable caching
        # ...remove 'proxy_cache off;' and 'proxy_buffering off;'...
    }

    # Images Caching
    location ~ ^/api/assets/.*/encoded.* {
        proxy_pass http://127.0.0.1:2283;

        # Enable caching
        proxy_cache images;
        proxy_cache_valid 200 2h;
        proxy_cache_valid any 5m;
        proxy_cache_revalidate on;
        proxy_cache_key "$request_uri";
        proxy_cache_min_uses 1;

        # Cache control headers
        add_header Cache-Control "public, must-revalidate, proxy-revalidate, max-age=86400, s-maxage=31536000" always;
        add_header Vary "Accept-Encoding" always;
        etag on;
        if_modified_since exact;
        gzip_static on;
        proxy_hide_header Set-Cookie;
        proxy_ignore_headers Set-Cookie;
    }

    # Videos Caching
    location ~ ^/api/assets/.*/transcode.* {
        proxy_pass http://127.0.0.1:2283;
        proxy_cache videos;
        proxy_cache_valid 200 7d;               # Week-long cache
        proxy_cache_valid any 5m;
        proxy_cache_key "$request_uri";
        proxy_buffers 32 512k;                  # 16MB buffer for videos
        proxy_max_temp_file_size 2048m;         # Allow large temp files
        proxy_read_timeout 900;                 # 15 minutes timeout
    }

    # Cache all requests under /api/assets/
    location ^~ /api/assets/ {
        proxy_pass http://127.0.0.1:2283;
        proxy_cache assets_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_valid any 1m;
        proxy_cache_revalidate on;
        proxy_cache_key "$request_uri";
        add_header Cache-Control "public, must-revalidate, proxy-revalidate, max-age=300";
        add_header Vary "Accept-Encoding";
        etag on;
        if_modified_since exact;
    }

    # Enable caching for /photos/*
    location ^~ /photos/ {
        proxy_pass http://127.0.0.1:2283;
        proxy_buffering on;
        
        # Caching configuration
        proxy_cache images;
        proxy_cache_valid 200 5m;
        proxy_cache_valid any 1m;
        proxy_cache_revalidate on;
        proxy_cache_key "$request_uri";
        proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
        
        # Browser caching headers
        add_header Cache-Control "public, must-revalidate, proxy-revalidate, max-age=300";
        add_header Vary "Accept-Encoding";
        etag on;
        if_modified_since exact;
    }

    # Static assets with Cloudflare caching
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|webp|svg)$ {
        proxy_pass http://127.0.0.1:2283;
        proxy_cache images;
        proxy_cache_valid 200 2h;               # Longer cache time
        proxy_cache_valid any 5m;
        proxy_cache_revalidate on;
        proxy_cache_key "$request_uri";
        proxy_cache_min_uses 1;                 # Cache immediately
        add_header Cache-Control "public, must-revalidate, proxy-revalidate, max-age=86400, s-maxage=31536000";
        add_header Vary "Accept-Encoding";
        etag on;
        if_modified_since exact;
        gzip_static on;
        proxy_hide_header Set-Cookie;
        proxy_ignore_headers Set-Cookie;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
        add_header X-Content-Type-Options "nosniff" always;
        
        # Cloudflare Rocket Loader hints
        add_header X-Content-Type-Options "nosniff";
        add_header X-XSS-Protection "1; mode=block";
    }

    # Default location for all other requests (root location)
    location / {
        proxy_pass http://127.0.0.1:2283;
        proxy_request_buffering off;
        proxy_buffering on;

        # Disable caching for dynamic content (homepage)
        add_header Cache-Control "private, no-store, no-cache, must-revalidate, proxy-revalidate" always;
        expires -1;

        # Keep WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 300;
        add_header Pragma "no-cache" always;
        add_header CF-Cache-Status $upstream_cache_status always;
    }

    # Add upload-specific location
    location ~ ^/api/upload {
        proxy_pass http://127.0.0.1:2283;
        
        # Increased buffer sizes for uploads
        client_max_body_size 0;  # Remove size limit or set to a very large value
        client_body_buffer_size 128k;
        proxy_request_buffering off;  # Disable request buffering for large uploads
        proxy_buffering off;  # Disable response buffering
        
        # Extended timeouts
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_connect_timeout 3600s;
        
        # Required headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Remove any caching headers
        proxy_set_header Cache-Control "no-cache";
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
        expires off;
        
        # CORS headers if needed
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    }
}