server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    http3 on;
    server_name qbit.imnot.uk;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/qbit.imnot.uk/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/qbit.imnot.uk/privkey.pem;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # Method restriction
    if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|OPTIONS|PATCH)$) {
        return 405;
    }

    # User agent restrictions
    if ($http_user_agent ~* (sqlmap|curl|wget|python|nikto|nmap|fuzz|scanner|bot)) {
        return 403;
    }

    if ($http_user_agent = "") {
        return 403;
    }

    # Protocol restriction
    if ($server_protocol !~ "^(HTTP/1\.0|HTTP/1\.1|HTTP/2\.0|HTTP/3)$") {
        return 400;
    }

    # Authelia authentication endpoint
    #    location /authelia {
    #        internal;
    #        set $upstream_authelia http://127.0.0.1:9091/api/verify;
    #        proxy_pass_request_body off;
    #        proxy_pass $upstream_authelia;
    #        proxy_set_header Content-Length "";
    #
    #        # Timeout settings
    #        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    #        proxy_connect_timeout 240;
    #        proxy_send_timeout 240;
    #        proxy_read_timeout 240;
    #        send_timeout 5m;
    #
    #        # Headers
    #        proxy_set_header Host $host;
    #        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
    #        proxy_set_header X-Real-IP $remote_addr;
    #        proxy_set_header X-Forwarded-For $remote_addr;
    #        proxy_set_header X-Forwarded-Proto $scheme;
    #        proxy_set_header X-Forwarded-Host $http_host;
    #        proxy_set_header X-Forwarded-Uri $request_uri;
    #        proxy_set_header X-Forwarded-Ssl on;
    #
    #        # Additional settings
    #        proxy_redirect http:// $scheme://;
    #        proxy_http_version 1.1;
    #        proxy_set_header Connection "";
    #        proxy_cache_bypass $cookie_session;
    #        proxy_no_cache $cookie_session;
    #    }

    # Main application
    location / {
        # Authelia authentication
        #auth_request /authelia;
        #auth_request_set $target_url https://$http_host$request_uri;
        #auth_request_set $user $upstream_http_remote_user;
        #auth_request_set $email $upstream_http_remote_email;
        #auth_request_set $groups $upstream_http_remote_groups;

        ## Authentication error handling
        #error_page 401 =302 https://auth.imnot.uk/?rd=$target_url;

        # Proxy settings
        proxy_pass http://127.0.0.1:2182;
        proxy_http_version 1.1;

        # Headers
        # proxy_set_header Remote-User $user;
        # proxy_set_header Remote-Email $email;
        # proxy_set_header Remote-Groups $groups;
        proxy_set_header Host $proxy_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $http_host;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Request size limit
        client_max_body_size 100M;

        # Cookie settings for qBittorrent
        proxy_cookie_path / "/; Secure";
    }

    # Static assets caching
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|webp|svg)$ {
        proxy_cache my_cache;
        proxy_cache_valid 200 24h;
        add_header Cache-Control "public, max-age=86400";
        expires 24h;
    }

    # Restrict access to sensitive files
    location ~ /\.(ht|git|svn|env|DS_Store|dockerignore|backup) {
        deny all;
        return 404;
    }

    # Prevent PHP execution
    location ~* /(uploads|files|images|temp)/.*\.php$ {
        deny all;
    }

    include /etc/nginx/default.d/*.conf;
}
