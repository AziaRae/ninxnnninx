# For more information on configuration, see:
#   * Official English Documentation: http://nginx.org/en/docs/
#   * Official Russian Documentation: http://nginx.org/ru/docs/

user nginx;
worker_processes 8; # Match CPU cores
worker_rlimit_nofile 65535; # Increase open file limit
error_log /var/log/nginx/error.log notice;
pid /run/nginx.pid;

# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 4096; # Higher connection limit for 24GB RAM
    multi_accept on; # Add this for better performance
}

http {
    # Hash table settings (must be before mime.types)
    types_hash_bucket_size 128;
    types_hash_max_size 4096;
    server_names_hash_bucket_size 128; # Better performance with many server blocks

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # SSL Configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ecdh_curve X25519:P-256:P-384;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-CHACHA20-POLY1305:ECDHE+AES128:RSA+AES128:ECDHE+AES256:RSA+AES256:ECDHE+3DES:RSA+3DES;
    ssl_prefer_server_ciphers on;
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    # ssl_verify_client on;
    # ssl_client_certificate /etc/nginx/ssl/cloudflare.crt;
    #include /etc/letsencrypt/options-ssl-nginx.conf
    ssl_session_cache shared:SSL:50m;
    ssl_dhparam /etc/nginx/dhparam.pem; # Generate this file

    # Base security headers - modified for better compatibility
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "0" always; # Modern recommendation is to disable this legacy header

    # Simplified Permissions-Policy for better performance
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), interest-cohort=()" always;

    # Adjusted Content-Security-Policy
    add_header Content-Security-Policy "
        default-src 'self' data: blob:;
        script-src 'self';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: blob:;
        connect-src 'self' wss:;
        font-src 'self' data:;
        media-src 'self' blob:;
        object-src 'none';
        frame-ancestors 'self';
    " always;

    # Referrer Policy - modified to be less strict
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # HSTS (31536000 seconds = 1 year)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Adjusted Cross-Origin policies for uploads
    add_header Cross-Origin-Embedder-Policy "unsafe-none" always;
    add_header Cross-Origin-Opener-Policy "same-origin-allow-popups" always;
    add_header Cross-Origin-Resource-Policy "same-site" always;

    # Client buffers - allocate ~2GB total for buffers
    client_body_buffer_size 2m; # Increased for faster file uploads
    client_max_body_size 0; # Keep unlimited
    client_header_buffer_size 32k; # Increased for complex headers
    large_client_header_buffers 8 128k; # Larger buffers for complex requests

    # Proxy buffers - configured correctly
    proxy_buffer_size          32k;      # Headers buffer (sufficient for most requests)
    proxy_buffers              32 128k;  # 32 buffers * 128k = 4MB per connection
    proxy_busy_buffers_size    1024k;    # 1MB busy buffer size (~25% of total buffers)
    proxy_temp_file_write_size 512k;     # Efficient SSD write size
    proxy_max_temp_file_size   8192m;    # 8GB max temp files (balanced for 24GB RAM)

    # Proxy and Cache Settings
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;
    proxy_cache_path /var/cache/nginx/app levels=1:2 keys_zone=app_cache:10m max_size=10g inactive=60m use_temp_path=off;
    proxy_cache_path /var/cache/nginx/thumbnails levels=1:2 keys_zone=thumbnails:10m max_size=10g inactive=60d use_temp_path=off;
    proxy_cache_path /var/cache/nginx/images levels=1:2 keys_zone=images:10m max_size=10g inactive=60d use_temp_path=off;
    proxy_cache_path /var/cache/nginx/videos levels=1:2 keys_zone=videos:10m max_size=10g inactive=60d use_temp_path=off;
    proxy_cache_path /var/cache/nginx/assets_cache levels=1:2 keys_zone=assets_cache:10m max_size=10g inactive=60m use_temp_path=off;
    proxy_cache_path /var/cache/nginx/search levels=1:2 keys_zone=search_cache:10m max_size=1g inactive=60m use_temp_path=off;
    
    proxy_cache_key "$scheme$request_method$host$request_uri";
    proxy_cache_valid 200 302 10m;
    proxy_cache_valid 404 1m;
    proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
    proxy_cache_methods GET HEAD POST;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
    '$status $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main buffer=32k flush=5s;

    # Enable multithreading and async I/O
    # sendfile on
    aio threads;
    aio_write on;
    directio 4m;
    output_buffers 16 1m;

    # TCP optimizations
    tcp_nopush on;
    tcp_nodelay on;

    # Load modular configuration files
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
    include /etc/nginx/default.d/*.conf;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=one:10m rate=30r/s;
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    # Enhanced SSL configuration
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 1.1.1.1 1.0.0.1 valid=300s;
    resolver_timeout 5s;

    # Performance optimizations
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # Gzip compression settings
    gzip_comp_level 5; # Better balance between CPU and compression
    gzip_min_length 1024; # Only compress content larger than 1KB
    gzip_vary on; # Add Vary header
    gzip_proxied any; # Compress for all proxied requests
    gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    text/x-component
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/rss+xml
    application/atom+xml
    application/ld+json
    application/manifest+json
    application/vnd.api+json
    application/x-web-app-manifest+json
    application/x-yaml
    application/yaml
    font/collection
    font/opentype
    font/otf
    font/ttf
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-font-opentype;
    # Note: image/* and video/* types are automatically excluded since not listed

    # Connection tuning for high bandwidth
    keepalive_requests 1000;
    keepalive_timeout 65s;
    
    # Disable server tokens
    server_tokens off;
}